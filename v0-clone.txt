# V0-Clone Project Setup Guide
# =============================
# Step-by-step implementation and commands to run

## 1. Create Next.js Project
   npx create-next-app@latest ./
   # Creates a new Next.js 16 project in the current directory
   # Includes: React 19, Turbopack, App Router, Tailwind CSS

## 2. Initialize Shadcn UI Components
   npx shadcn@latest init
   # Sets up Shadcn UI component library
   # Creates: components.json, src/components/ui/, src/lib/utils.js
   # Configures: Tailwind CSS with custom theme variables

## 3. Install Prisma (Database ORM)
   npm i prisma@5.22.0 @prisma/client@5.22.0
   # prisma: CLI tool for migrations and schema management
   # @prisma/client: Auto-generated type-safe database client
   # NOTE: Using v5.22.0 for stability with Next.js 16

## 4. Initialize Prisma
   npx prisma init
   # Creates:
   #   - prisma/schema.prisma (database schema definition)
   #   - .env file with DATABASE_URL placeholder
   # You need to:
   #   - Set up docker-compose.yml for PostgreSQL
   #   - Update DATABASE_URL in .env

## 5. Database Commands (Prisma)

   ### Generate Prisma Client
   npx prisma generate
   # Generates the Prisma Client based on your schema
   # Run this after: changing schema.prisma
   # Creates: node_modules/.prisma/client/

   ### Create & Apply Migrations
   npx prisma migrate dev --name <migration_name>
   # Creates a new migration file in prisma/migrations/
   # Applies the migration to your database
   # Regenerates Prisma Client automatically
   # Example: npx prisma migrate dev --name add_user_fields

   ### Reset Database (DESTRUCTIVE)
   npx prisma migrate reset --force
   # Drops all tables and data
   # Reapplies all migrations from scratch
   # Use when: migration conflicts, starting fresh, test data cleanup

   ### View Database (GUI)
   npx prisma studio
   # Opens a browser-based database GUI at http://localhost:5555
   # View, edit, and delete records visually

## 6. Docker (PostgreSQL Database)

   ### Start Database
   docker compose up -d
   # Starts PostgreSQL container in background
   # Database available at: localhost:5431

   ### Stop Database
   docker compose down
   # Stops and removes the PostgreSQL container

   ### View Running Containers
   docker ps
   # Lists all running Docker containers

## 7. Clerk Authentication

   ### Install Clerk
   npm i @clerk/nextjs
   # Provides: SignIn, SignUp, UserButton components
   # Middleware for route protection

   ### Required Files:
   # - src/middleware.js (middleware for Next.js 16)
   # - src/app/layout.js (wrap with ClerkProvider)
   # - .env (NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY)

   ### Environment Variables (add to .env):
   # NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   # CLERK_SECRET_KEY=sk_test_...
   # NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   # NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up

## 8. Development Commands

   ### Start Development Server
   npm run dev
   # Starts: Docker DB + Next.js dev server
   # Available at: http://localhost:3000

   ### Build for Production
   npm run build
   # Creates optimized production build

   ### Start Production Server
   npm start
   # Runs the production build

   ### Lint Code
   npm run lint
   # Runs ESLint to check for code issues

## 9. New Implementations & Packages

   ### Inngest (Background Jobs)
   npm install inngest @inngest/agent-kit
   # Purpose: Handling background jobs, workflows, and AI agent execution.
   # Key Files:
   #   - src/inngest/client.js: Initialized Inngest client
   #   - src/app/api/inngest/route.js: Next.js API route to handle Inngest events
   #   - src/inngest/functions.js: Define your background functions (e.g., helloWorld)

   #### Run Inngest Dev Server
   npx inngest-cli@latest dev
   # Opens Inngest dashboard at http://localhost:8288
   # Connects to your local Next.js app to trigger/test functions

   ### TanStack Query (React Query)
   npm install @tanstack/react-query
   # Purpose: Managing server state, caching, and data fetching in React components.
   # Implementation:
   #   - Wrapped app in `QueryClientProvider` (src/components/query-provider.jsx)
   #   - Using `useQuery` and `useMutation` hooks for data handling
   #   - *Note*: Temporarily disabled in layout/forms to simplify current dev flow, but installed and ready.

   ### Sonner (Toast Notifications)
   npm install sonner
   # Purpose: Showing success/error toast notifications.
   # Implementation:
   #   - Added `<Toaster />` to `src/app/layout.js` inside ThemeProvider
   #   - Usage: `toast.success("Message")` or `toast.error("Error")`

## Project Structure (Updated)
   v0-clone/
   ├── prisma/
   │   ├── schema.prisma      # Database schema
   │   └── migrations/        # Migration history
   ├── src/
   │   ├── app/               # Next.js App Router pages
   │   │   ├── (root)/        # Route group for main pages
   │   │   │   ├── projects/
   │   │   │   │   └── [projectId]/  # Dynamic project route
   │   │   │   │       └── page.jsx  # Project detail page
   │   │   │   ├── page.jsx   # Home page
   │   │   │   └── layout.jsx # Root layout
   │   │   ├── api/inngest/   # Inngest API route
   │   │   ├── layout.js      # Root layout (Clerk, Theme, Toaster)
   │   │   └── globals.css    # Styles
   │   ├── components/ui/     # Shadcn UI components
   │   ├── inngest/           # Inngest client & functions
   │   ├── lib/
   │   │   ├── db.js          # Prisma singleton
   │   │   └── utils.js       # Utils
   │   ├── modules/
   │   │   ├── auth/          # Auth related actions
   │   │   ├── home/          # Home page components (ProjectForm)
   │   │   └── projects/      # Project actions & hooks
   │   └── middleware.js      # Clerk middleware
   ├── docker-compose.yml     # PostgreSQL container config
   ├── package.json           # Dependencies
   └── .env                   # Environment variables

## 10. AI Agent Setup (Gemini & E2B Code Interpreter)

   ### Tech Stack
   # - Library: @inngest/agent-kit, @e2b/code-interpreter, zod
   # - AI Provider: Google Gemini (gemini-2.5-flash)
   # - Execution Environment: E2B Sandbox (Custom Next.js 16 Template)

   ### Configuration Details
   # Location: src/inngest/functions.js
   # Helper Files:
   #   - src/prompt.js: Contains the "PROMPT" constant with strict system instructions for the agent.
   #   - src/inngest/utils.js: Helper (lastAssistantTextMessageContent) to parse agent output.

   ### Agent Capability (The "Code Agent")
   # Name: code-agent
   # Description: Expert coding agent that can write code, run commands, and manage files.
   # System Prompt: Imported from src/prompt.js (enforces Next.js 16/Tailwind/Shadcn rules).
   # NOTE: System prompt is passed directly as value: `system: PROMPT` (not a function)

   ### Implemented Tools (Agent Tools)
   # 1. terminal: Executes shell commands in the E2B sandbox.
   # 2. createOrUpdateFiles: Writes/updates multiple files in the sandbox.
   # 3. readFiles: Reads content of specified files from the sandbox.
   # Reference: https://agentkit.inngest.com/concepts/tools

   ### Trigger & Execution
   # Event Name: 'code-agent/run'
   # Function ID: 'code-agent'
   # Sandbox Template: 'v0-nextjs-build-new'
   # Workflow:
   #   1. Agent receives a prompt.
   #   2. "Network" (of agents) processes the request (router loop).
   #   3. Tools execute actions in the E2B sandbox.
   #   4. Saves result to database with Message + Fragment (nested create).
   #   5. Returns: Sandbox URL, list of modified files, and summary.

   ### Database Result Structure
   # The agent saves results using Prisma's nested create:
   #   db.message.create({
   #     data: {
   #       projectId, content, role, type,
   #       fragments: {
   #         create: { sandboxUrl, title, files }
   #       }
   #     }
   #   })


## 11. E2B Sandbox Setup (Code Interpreter)

   ### Prerequisites
   npm i @e2b/code-interpreter
   npm i -g @e2b/cli
   # @e2b/code-interpreter: SDK to communicate with the sandbox
   # @e2b/cli: CLI tool to build and manage custom templates

   ### Authentication & Verification
   e2b auth login
   # Logs you into your E2B account

   e2b sandbox list
   # Lists your available sandbox templates to verify access

   ### Build Custom Template
   # 1. Navigate to the template directory
   cd sanbox-templates/nextjs

   # 2. Build the template
   e2b template build --name v0-nextjs-build-atts --cmd "/compile_page.sh"
   # --name: The alias for your template (must be unique)
   # --cmd: The startup command for the sandbox
   # Note: If you get a '403 Forbidden' error, try a different name or check your team permissions.

   ### Publish Template
   # To make the template available to your team permanently:
   e2b template publish -t {teamId}
   # Replace {teamId} with your actual Team ID found in the E2B dashboard.

## Troubleshooting

   ### Prisma Client Not Found
   npx prisma generate
   # Regenerates the Prisma client

   ### Database Connection Failed
   docker compose up -d
   # Make sure PostgreSQL container is running

   ### Migration Conflicts
   npx prisma migrate reset --force
   npx prisma migrate dev
   # Reset and reapply all migrations

   ### Turbopack Crashes (Windows)
   # Enable Developer Mode in Windows Settings:
   # Settings > Privacy & Security > For Developers > Developer Mode ON

   ### Hydration Mismatch Errors
   # Add suppressHydrationWarning to <html> and <body> tags
   # Use dynamic prop on ClerkProvider: <ClerkProvider dynamic>

   ### Theme/Dark Mode Not Working
   # Issue: LocalStorage conflict or Tailwind v4 variant specificity
   # Fix 1: Add unique storageKey prop to ThemeProvider in src/app/layout.js
   # Fix 2: Update dark variant in globals.css to: @custom-variant dark (&:where(.dark, .dark *));

   ### "No QueryClient set" Error
   # Cause: Using `useQuery` or `useMutation` without wrapping the app in `QueryClientProvider`.
   # Fix:
   #   1. Create src/components/query-provider.jsx
   #   2. Import and wrap {children} in src/app/layout.js with <QueryProvider>

   ### Inngest Agent Error: "this.system is not a function"
   # Cause: Missing 'system' property or invalid type in createAgent configuration.
   # Fix:
   #   - Add `system` property to createAgent() config in src/inngest/functions.js
   #   - Ensure it is a function returning a string: `system: () => "System Prompt"`

   ### E2B Build Error: "403 Forbidden"
   # Cause: The template name (alias) is already taken.
   # Fix: Use a unique name for your template, e.g., v0-nextjs-build-yourname-01.

   ### Inngest AgentKit: "TypeError: _a.clone is not a function"
   # Cause: Version incompatibility or network.run() not receiving the step instance.
   # Fix Option 1: Pass step to network.run(): `network.run(input, { step })`
   # Fix Option 2: Downgrade inngest to v3.44.2 if issues persist.
   # Reference: https://github.com/inngest/agent-kit/issues/196

   ### Inngest AgentKit: "Cannot read properties of undefined (reading 'state')"
   # Cause: Accessing network.state.data before it's initialized.
   # Fix: Use optional chaining: `network?.state?.data?.files || {}`
   # Or add defaultState to createNetwork():
   #   createNetwork({
   #     defaultState: { files: {}, summary: null },
   #     ...
   #   })

   ### 404 on /projects/[id] after project creation
   # Cause: Missing dynamic route page.
   # Fix: Create src/app/(root)/projects/[projectId]/page.jsx
