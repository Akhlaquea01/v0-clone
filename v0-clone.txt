# V0-Clone Project Setup Guide
# =============================
# Step-by-step implementation and commands to run

## 1. Create Next.js Project
   npx create-next-app@latest ./
   # Creates a new Next.js 16 project in the current directory
   # Includes: React 19, Turbopack, App Router, Tailwind CSS

## 2. Initialize Shadcn UI Components
   npx shadcn@latest init
   # Sets up Shadcn UI component library
   # Creates: components.json, src/components/ui/, src/lib/utils.js
   # Configures: Tailwind CSS with custom theme variables

## 3. Install Prisma (Database ORM)
   npm i prisma@5.22.0 @prisma/client@5.22.0
   # prisma: CLI tool for migrations and schema management
   # @prisma/client: Auto-generated type-safe database client
   # NOTE: Using v5.22.0 for stability with Next.js 16

## 4. Initialize Prisma
   npx prisma init
   # Creates:
   #   - prisma/schema.prisma (database schema definition)
   #   - .env file with DATABASE_URL placeholder
   # You need to:
   #   - Set up docker-compose.yml for PostgreSQL
   #   - Update DATABASE_URL in .env

## 5. Database Commands (Prisma)

   ### Generate Prisma Client
   npx prisma generate
   # Generates the Prisma Client based on your schema
   # Run this after: changing schema.prisma
   # Creates: node_modules/.prisma/client/

   ### Create & Apply Migrations
   npx prisma migrate dev --name <migration_name>
   # Creates a new migration file in prisma/migrations/
   # Applies the migration to your database
   # Regenerates Prisma Client automatically
   # Example: npx prisma migrate dev --name add_user_fields

   ### Reset Database (DESTRUCTIVE)
   npx prisma migrate reset --force
   # Drops all tables and data
   # Reapplies all migrations from scratch
   # Use when: migration conflicts, starting fresh, test data cleanup

   ### View Database (GUI)
   npx prisma studio
   # Opens a browser-based database GUI at http://localhost:5555
   # View, edit, and delete records visually

## 6. Docker (PostgreSQL Database)

   ### Start Database
   docker compose up -d
   # Starts PostgreSQL container in background
   # Database available at: localhost:5431

   ### Stop Database
   docker compose down
   # Stops and removes the PostgreSQL container

   ### View Running Containers
   docker ps
   # Lists all running Docker containers

## 7. Clerk Authentication

   ### Install Clerk
   npm i @clerk/nextjs
   # Provides: SignIn, SignUp, UserButton components
   # Middleware for route protection

   ### Required Files:
   # - src/middleware.js (middleware for Next.js 16)
   # - src/app/layout.js (wrap with ClerkProvider)
   # - .env (NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY)

   ### Environment Variables (add to .env):
   # NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   # CLERK_SECRET_KEY=sk_test_...
   # NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   # NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up

## 8. Development Commands

   ### Start Development Server
   npm run dev
   # Starts: Docker DB + Next.js dev server
   # Available at: http://localhost:3000

   ### Build for Production
   npm run build
   # Creates optimized production build

   ### Start Production Server
   npm start
   # Runs the production build

   ### Lint Code
   npm run lint
   # Runs ESLint to check for code issues

## 9. All Packages & Dependencies

   ### Core Framework
   # next@16.1.0 - React framework with App Router, Turbopack
   # react@19.2.3 - UI library
   # react-dom@19.2.3 - React DOM renderer

   ### Authentication
   npm install @clerk/nextjs @clerk/themes
   # @clerk/nextjs@^6.36.5 - Clerk authentication for Next.js
   #   - Components: SignIn, SignUp, UserButton
   #   - Middleware for route protection
   #   - Files: src/middleware.js, wrap layout with ClerkProvider
   # @clerk/themes@^2.4.24 - Pre-built themes for Clerk components
   #   - Usage: <ClerkProvider appearance={{ baseTheme: dark }}>

   ### Database
   npm install prisma@5.22.0 @prisma/client@5.22.0
   # prisma@^5.22.0 - CLI for migrations and schema management
   # @prisma/client@^5.22.0 - Auto-generated type-safe database client
   # NOTE: Using v5.22.0 for stability with Next.js 16

   ### AI & Background Jobs
   npm install inngest @inngest/agent-kit @e2b/code-interpreter zod
   # inngest@^3.44.0 - Durable workflow execution
   # @inngest/agent-kit@^0.13.0 - AI agent framework
   #   - createAgent, createTool, createNetwork, createState
   # @e2b/code-interpreter@^2.3.3 - Sandboxed code execution
   # zod@^4.2.1 - Schema validation for tool parameters

   #### Inngest Dev Server
   npx inngest-cli@latest dev
   # Opens dashboard at http://localhost:8288

   #### E2B CLI (for template management)
   npm install -g @e2b/cli
   e2b auth login
   e2b template build --name your-template --cmd "/compile_page.sh"

   ### State Management & Data Fetching
   npm install @tanstack/react-query
   # @tanstack/react-query@^5.90.2 - Server state, caching, mutations
   # Implementation:
   #   - Wrapped app in QueryClientProvider (src/components/query-provider.jsx)
   #   - Using useQuery and useMutation hooks

   ### UI Component Libraries
   npx shadcn@latest init
   npm install class-variance-authority clsx tailwind-merge lucide-react
   # Shadcn UI - Pre-built accessible components from @/components/ui/
   # class-variance-authority@^0.7.1 - Component variants
   # clsx@^2.1.1 - Conditional class names
   # tailwind-merge@^3.4.0 - Merge Tailwind classes
   # lucide-react@^0.562.0 - Icon library
   #   - Usage: import { IconName } from "lucide-react"

   ### Radix UI Primitives (installed with Shadcn)
   # @radix-ui/react-accordion, @radix-ui/react-alert-dialog
   # @radix-ui/react-avatar, @radix-ui/react-checkbox
   # @radix-ui/react-collapsible, @radix-ui/react-dialog
   # @radix-ui/react-dropdown-menu, @radix-ui/react-label
   # @radix-ui/react-popover, @radix-ui/react-progress
   # @radix-ui/react-scroll-area, @radix-ui/react-select
   # @radix-ui/react-separator, @radix-ui/react-slider
   # @radix-ui/react-slot, @radix-ui/react-switch
   # @radix-ui/react-tabs, @radix-ui/react-toggle
   # @radix-ui/react-tooltip, @radix-ui/react-hover-card
   # @radix-ui/react-context-menu, @radix-ui/react-menubar
   # @radix-ui/react-navigation-menu, @radix-ui/react-radio-group
   # @radix-ui/react-aspect-ratio, @radix-ui/react-toggle-group

   ### Layout & Panels
   npm install react-resizable-panels@3.0.6
   # react-resizable-panels@^3.0.6 - Resizable split-pane layouts
   # Components: ResizablePanelGroup, ResizablePanel, ResizableHandle
   # NOTE: v3.0.6 for Next.js 16 compatibility
   # Usage: Project view splits chat (35%) and preview (65%)

   ### Forms
   npm install react-hook-form @hookform/resolvers react-textarea-autosize
   # react-hook-form@^7.68.0 - Form state management
   # @hookform/resolvers@^5.2.2 - Validation resolvers (Zod integration)
   # react-textarea-autosize@^8.5.9 - Auto-expanding textareas
   #   - Usage: Chat input form with auto-resize

   ### Notifications
   npm install sonner
   # sonner@^2.0.7 - Toast notifications
   # Setup: Add <Toaster /> to layout.js inside ThemeProvider
   # Usage: toast.success("Message"), toast.error("Error")

   ### Theming
   npm install next-themes
   # next-themes@^0.4.6 - Dark/Light mode switching
   # Setup: Wrap app in ThemeProvider with attribute="class"
   # Usage: useTheme() hook for theme switching

   ### Syntax Highlighting
   npm install prismjs
   # prismjs@^1.30.0 - Code syntax highlighting
   # Languages: typescript, jsx, tsx, javascript, python
   # Theme: Custom GitHub-style (code-theme.css)
   # Usage: In CodeView component for file explorer

   ### Markdown Rendering
   npm install streamdown
   # streamdown@^1.3.0 - Streaming markdown renderer
   # Usage: <Response>{markdownContent}</Response>
   # Location: src/components/ai-elements/response.jsx

   ### Date & Time
   npm install date-fns
   # date-fns@^4.1.0 - Date utility library
   # Usage: formatDistanceToNow for relative timestamps

   ### Carousel
   npm install embla-carousel-react
   # embla-carousel-react@^8.6.0 - Carousel component
   # Used in: ProjectList mobile view with navigation arrows

   ### Charts
   npm install recharts
   # recharts@^2.15.4 - Charting library
   # Usage: Dashboard analytics, usage stats

   ### Drawer/Sheet
   npm install vaul
   # vaul@^1.1.2 - Drawer component for mobile
   # Used with: Shadcn Sheet component

   ### Command Palette
   npm install cmdk
   # cmdk@^1.1.1 - Command menu component
   # Used with: Shadcn Command component

   ### Date Picker
   npm install react-day-picker
   # react-day-picker@^9.13.0 - Calendar/date picker
   # Used with: Shadcn Calendar component

   ### OTP Input
   npm install input-otp
   # input-otp@^1.4.2 - OTP input component
   # Used with: Shadcn InputOTP component

   ### Utilities
   npm install random-word-slugs
   # random-word-slugs@^0.1.7 - Generate random project names
   # Usage: Default project name generation

   npm install rate-limiter-flexible
   # rate-limiter-flexible@^8.0.1 - API rate limiting
   # Usage: Protect API routes from abuse

   ### Dev Dependencies
   npm install -D tailwindcss@4 @tailwindcss/postcss eslint eslint-config-next tw-animate-css
   # tailwindcss@^4 - CSS framework
   # @tailwindcss/postcss - PostCSS plugin
   # eslint@^9 - Linting
   # eslint-config-next@16.1.0 - Next.js ESLint config
   # tw-animate-css@^1.4.0 - Tailwind animation utilities

## 12. Project View UI Components

   ### ProjectView (src/modules/projects/components/project-view.jsx)
   # Main container for project workspace
   # Uses ResizablePanelGroup with horizontal split:
   #   - Left Panel (35%): Chat/messages area with ProjectHeader + MessageContainer
   #   - Right Panel (65%): Tabs for Preview (FragmentWeb) and Code (FileExplorer)
   # State: activeFragment (selected sandbox), tabState (preview/code)

   ### ProjectHeader (src/modules/projects/components/project-header.jsx)
   # Header component with:
   #   - Logo and project name dropdown
   #   - Navigation back to dashboard
   #   - Theme switcher (Light/Dark/System)
   # Uses: useGetProjectById hook, Dropdown Menu, next-themes

   ### ProjectList (src/modules/home/components/project-list.jsx)
   # Displays user's projects on the home page
   # Features:
   #   - Desktop: 3-column grid layout
   #   - Mobile: Carousel with navigation arrows
   #   - Hover animations and emerald accent colors
   # Uses: useGetProjects hook, Carousel component

   ### MessageContainer (src/modules/projects/components/message-container.jsx)
   # Displays chat messages with auto-scroll and loading states
   # Features:
   #   - Prefetches messages on mount
   #   - Auto-selects latest assistant's fragment
   #   - Shows MessageLoading when waiting for AI response
   # Uses: useGetMessages hook, prefetchMessages

   ### MessageCard (src/modules/projects/components/message-card.jsx)
   # Renders individual chat messages (user or assistant)
   # Types: UserMessage (right-aligned), AssistantMessage (with logo, timestamp)
   # FragmentCard: Clickable button to select code preview

   ### MessageForm (src/modules/projects/components/message-form.jsx)
   # Chat input form with auto-resize textarea
   # Features: Cmd+Enter submit, validation, loading state
   # Uses: useCreateMessages hook, react-textarea-autosize

   ### MessageLoading (src/modules/projects/components/message-loader.jsx)
   # Animated loading indicator with rotating status messages
   # Messages: "Thinking...", "Generating...", "Almost there..." etc.

   ### FragmentWeb (src/modules/projects/components/fragment-web.jsx)
   # Preview panel for sandbox URL (iframe)
   # Features:
   #   - Refresh button (reloads iframe)
   #   - Copy URL to clipboard
   #   - Open in new tab
   # Uses: Hint component for tooltips

   ### FileExplorer (src/modules/projects/components/file-explorer.jsx)
   # Code view with file tree sidebar
   # Features:
   #   - Resizable tree/code split (25%/75%)
   #   - Breadcrumb navigation
   #   - Copy code to clipboard
   # Uses: TreeView, CodeView, convertFilesToTreeItems

   ### TreeView (src/modules/projects/components/tree-view.jsx)
   # File tree sidebar using Shadcn Sidebar components
   # Recursive rendering of folders (collapsible) and files
   # Icons: FolderIcon, FileIcon, ChevronRightIcon

   ### CodeView (src/modules/projects/components/code-view/index.jsx)
   # Syntax-highlighted code display using PrismJS
   # Auto-highlights on code/language change
   # Theme: code-theme.css (GitHub-style light/dark)

## 13. Messages Module

   ### Server Actions (src/modules/messages/actions/index.js)
   # - createMessages(value, projectId): Creates user message + triggers Inngest agent
   # - getMessages(projectId): Fetches all messages with fragments (ordered by updatedAt)

   ### React Query Hooks (src/modules/messages/hooks/message.js)
   # - prefetchMessages(queryClient, projectId): Prefetch for faster loading
   # - useGetMessages(projectId): Query with 10s stale time, 5s refetch interval
   # - useCreateMessages(projectId): Mutation with cache invalidation

## 14. Utility Components

   ### Hint (src/components/ui/hint.jsx)
   # Tooltip wrapper for consistent tooltip styling
   # Props: text, label, side, align, sideOffset, delayDuration
   # Uses: Shadcn Tooltip components

   ### convertFilesToTreeItems (src/lib/utils.js)
   # Utility function to transform flat file paths into nested tree structure
   # Input: { "src/app/page.jsx": "..." }
   # Output: [["src", ["app", "page.jsx"]]]

   ### Response (src/components/ai-elements/response.jsx)
   # Markdown rendering component using Streamdown
   # Purpose: Renders AI responses with proper markdown formatting
   # Uses: streamdown library, memo for performance
   # Usage: <Response>{markdownContent}</Response>

   ### Streamdown Package
   npm install streamdown
   # Purpose: Markdown streaming and rendering
   # Used in: Response component for AI message display


## Project Structure (Updated)
   v0-clone/
   ├── prisma/
   │   ├── schema.prisma      # Database schema
   │   └── migrations/        # Migration history
   ├── src/
   │   ├── app/               # Next.js App Router pages
   │   │   ├── (root)/        # Route group for main pages (with layout)
   │   │   │   ├── page.jsx   # Home page (ProjectForm + ProjectList)
   │   │   │   └── layout.jsx # Root layout with navigation
   │   │   ├── projects/
   │   │   │   └── [projectId]/  # Dynamic project route (outside root group)
   │   │   │       └── page.jsx  # Project detail page (renders ProjectView)
   │   │   ├── api/inngest/   # Inngest API route
   │   │   ├── layout.js      # Root layout (Clerk, Theme, Toaster)
   │   │   └── globals.css    # Styles
   │   ├── components/
   │   │   ├── ui/               # Shadcn UI components (Spinner, Hint, etc.)
   │   │   └── ai-elements/
   │   │       └── response.jsx  # Markdown rendering with Streamdown
   │   ├── inngest/           # Inngest client & functions
   │   ├── lib/
   │   │   ├── db.js          # Prisma singleton
   │   │   └── utils.js       # Utils + convertFilesToTreeItems
   │   ├── modules/
   │   │   ├── auth/          # Auth related actions
   │   │   ├── home/
   │   │   │   └── components/
   │   │   │       ├── project-form.jsx   # Form to create new project
   │   │   │       └── project-list.jsx   # Carousel/grid of user projects
   │   │   ├── messages/
   │   │   │   ├── actions/index.js       # createMessages, getMessages
   │   │   │   └── hooks/message.js       # useGetMessages, useCreateMessages
   │   │   └── projects/
   │   │       ├── actions/index.js       # Server actions (CRUD)
   │   │       ├── hooks/project.js       # React Query hooks
   │   │       └── components/
   │   │           ├── project-view.jsx     # Main project view (ResizablePanels)
   │   │           ├── project-header.jsx   # Header with dropdown menu
   │   │           ├── message-container.jsx # Chat messages display
   │   │           ├── message-card.jsx     # Individual message component
   │   │           ├── message-form.jsx     # Chat input form
   │   │           ├── message-loader.jsx   # Loading animation
   │   │           ├── fragment-web.jsx     # Sandbox preview iframe
   │   │           ├── file-explorer.jsx    # Code view with tree
   │   │           ├── tree-view.jsx        # File tree sidebar
   │   │           └── code-view/
   │   │               ├── index.jsx        # PrismJS code display
   │   │               └── code-theme.css   # GitHub dark/light theme
   │   └── middleware.js      # Clerk middleware
   ├── docker-compose.yml     # PostgreSQL container config
   ├── package.json           # Dependencies
   └── .env                   # Environment variables

## 10. AI Agent Setup (Gemini & E2B Code Interpreter)

   ### Tech Stack
   # - Library: @inngest/agent-kit, @e2b/code-interpreter, zod
   # - AI Provider: Google Gemini (gemini-2.5-flash)
   # - Execution Environment: E2B Sandbox (Custom Next.js 16 Template)

   ### Configuration Details
   # Location: src/inngest/functions.js
   # Helper Files:
   #   - src/prompt.js: Contains multiple prompts for the agent system
   #   - src/inngest/utils.js: Helper (lastAssistantTextMessageContent) to parse agent output

   ### System Prompts (src/prompt.js)
   # PROMPT: Main agent prompt for code generation (Next.js 16/Tailwind/Shadcn)
   # FRAGMENT_TITLE_PROMPT: Generates short 3-word titles for fragments (e.g., "Landing Page")
   # RESPONSE_PROMPT: Generates user-friendly 1-3 sentence responses explaining what was built

   ### Multi-Agent Architecture
   # 1. Code Agent (Primary)
   #    - Name: code-agent
   #    - Purpose: Writes code, runs commands, manages files in sandbox
   #    - System: PROMPT (enforces Next.js/Tailwind/Shadcn rules)
   #
   # 2. Fragment Title Generator (Post-processing)
   #    - Name: fragment-title-generator
   #    - Purpose: Creates short descriptive titles for code fragments
   #    - System: FRAGMENT_TITLE_PROMPT
   #    - Output: Max 3 words, title case (e.g., "Chat Widget")
   #
   # 3. Response Generator (Post-processing)
   #    - Name: response-generator
   #    - Purpose: Creates user-friendly explanation of what was built
   #    - System: RESPONSE_PROMPT
   #    - Output: 1-3 sentences in markdown format

   ### Implemented Tools (Code Agent)
   # 1. terminal: Executes shell commands in the E2B sandbox
   # 2. createOrUpdateFiles: Writes/updates multiple files in the sandbox
   # 3. readFiles: Reads content of specified files from the sandbox
   # Reference: https://agentkit.inngest.com/concepts/tools

   ### Trigger & Execution Workflow
   # Event Name: 'code-agent/run'
   # Function ID: 'code-agent'
   # Sandbox Template: 'v0-nextjs-build-new'
   #
   # Workflow:
   #   1. Code Agent receives prompt and generates code in sandbox
   #   2. Network router loops until task_summary is found
   #   3. Fragment Title Generator creates title from summary
   #   4. Response Generator creates user-friendly message
   #   5. Results saved to database: Message + Fragment (nested create)
   #   6. Returns: Sandbox URL, files, title, and response

   ### Database Result Structure
   # The agent saves results using Prisma's nested create:
   #   db.message.create({
   #     data: {
   #       projectId, content, role, type,
   #       fragments: {
   #         create: { sandboxUrl, title, files }
   #       }
   #     }
   #   })


## 11. E2B Sandbox Setup (Code Interpreter)

   ### Prerequisites
   npm i @e2b/code-interpreter
   npm i -g @e2b/cli
   # @e2b/code-interpreter: SDK to communicate with the sandbox
   # @e2b/cli: CLI tool to build and manage custom templates

   ### Authentication & Verification
   e2b auth login
   # Logs you into your E2B account

   e2b sandbox list
   # Lists your available sandbox templates to verify access

   ### Build Custom Template
   # 1. Navigate to the template directory
   cd sanbox-templates/nextjs

   # 2. Build the template
   e2b template build --name v0-nextjs-build-atts --cmd "/compile_page.sh"
   # --name: The alias for your template (must be unique)
   # --cmd: The startup command for the sandbox
   # Note: If you get a '403 Forbidden' error, try a different name or check your team permissions.

   ### Publish Template
   # To make the template available to your team permanently:
   e2b template publish -t {teamId}
   # Replace {teamId} with your actual Team ID found in the E2B dashboard.

## Troubleshooting

   ### Prisma Client Not Found
   npx prisma generate
   # Regenerates the Prisma client

   ### Database Connection Failed
   docker compose up -d
   # Make sure PostgreSQL container is running

   ### Migration Conflicts
   npx prisma migrate reset --force
   npx prisma migrate dev
   # Reset and reapply all migrations

   ### Turbopack Crashes (Windows)
   # Enable Developer Mode in Windows Settings:
   # Settings > Privacy & Security > For Developers > Developer Mode ON

   ### Hydration Mismatch Errors (ResizablePanels, Radix UI)
   # Cause: Components like ResizablePanelGroup, Tabs, DropdownMenu generate
   #        unique IDs that differ between server and client renders.
   #
   # Error Message: "A tree hydrated but some attributes of the server rendered
   #                 HTML didn't match the client properties"
   #
   # Fix: Use Next.js dynamic import with ssr: false via a Client Component wrapper
   #
   # Step 1: Create a wrapper component (src/app/projects/[projectId]/project-view-wrapper.jsx):
   #   "use client";
   #   import dynamic from "next/dynamic";
   #   const ProjectView = dynamic(
   #       () => import("@/modules/projects/components/project-view"),
   #       { ssr: false }
   #   );
   #   export default function ProjectViewWrapper({ projectId }) {
   #       return <ProjectView projectId={projectId} />;
   #   }
   #
   # Step 2: Use the wrapper in the page (src/app/projects/[projectId]/page.jsx):
   #   import ProjectViewWrapper from "./project-view-wrapper";
   #   const Page = async ({ params }) => {
   #       const { projectId } = await params;
   #       return <ProjectViewWrapper projectId={projectId} />;
   #   };
   #
   # NOTE: ssr: false is NOT allowed in Server Components in Next.js 16+
   #       You MUST use a "use client" wrapper component for this pattern

   ### Theme/Dark Mode Not Working
   # Issue: LocalStorage conflict or Tailwind v4 variant specificity
   # Fix 1: Add unique storageKey prop to ThemeProvider in src/app/layout.js
   # Fix 2: Update dark variant in globals.css to: @custom-variant dark (&:where(.dark, .dark *));

   ### "No QueryClient set" Error
   # Cause: Using `useQuery` or `useMutation` without wrapping the app in `QueryClientProvider`.
   # Fix:
   #   1. Create src/components/query-provider.jsx
   #   2. Import and wrap {children} in src/app/layout.js with <QueryProvider>

   ### Inngest Agent Error: "this.system is not a function"
   # Cause: Missing 'system' property or invalid type in createAgent configuration.
   # Fix:
   #   - Add `system` property to createAgent() config in src/inngest/functions.js
   #   - Ensure it is a function returning a string: `system: () => "System Prompt"`

   ### E2B Build Error: "403 Forbidden"
   # Cause: The template name (alias) is already taken.
   # Fix: Use a unique name for your template, e.g., v0-nextjs-build-yourname-01.

   ### Inngest AgentKit: "TypeError: _a.clone is not a function"
   # Cause: Version incompatibility or network.run() not receiving the step instance.
   # Fix Option 1: Pass step to network.run(): `network.run(input, { step })`
   # Fix Option 2: Downgrade inngest to v3.44.2 if issues persist.
   # Reference: https://github.com/inngest/agent-kit/issues/196

   ### Inngest AgentKit: "Cannot read properties of undefined (reading 'state')"
   # Cause: Accessing network.state.data before it's initialized.
   # Fix: Use optional chaining: `network?.state?.data?.files || {}`
   # Or add defaultState to createNetwork():
   #   createNetwork({
   #     defaultState: { files: {}, summary: null },
   #     ...
   #   })

   ### 404 on /projects/[id] after project creation
   # Cause: Missing dynamic route page.
   # Fix: Create src/app/(root)/projects/[projectId]/page.jsx

## 15. Conversation History & Agent Context

   ### Overview
   # The AI agent now has memory of previous conversations and files.
   # This enables follow-up requests like "add a contact form" or "change the color"
   # to build upon existing work instead of starting from scratch.

   ### Implementation Details (src/inngest/functions.js)

   # 1. Import createState from @inngest/agent-kit:
   #    import { createAgent, createTool, createNetwork, createState } from "@inngest/agent-kit";

   # 2. Load Previous Messages & Files:
   #    const { formattedMessages, latestFiles } = await step.run(
   #        "get-previous-messages",
   #        async () => {
   #            const messages = await db.message.findMany({
   #                where: { projectId, type: { not: "ERROR" } },
   #                orderBy: { createdAt: "asc" },  // Chronological order!
   #                include: { fragments: true },
   #                take: 30  // Limit for token efficiency
   #            });
   #
   #            // Build formatted messages and extract files from fragments
   #            // ...
   #            return { formattedMessages, latestFiles };
   #        }
   #    );

   # 3. Create State with History:
   #    const state = createState(
   #        { summary: "", files: latestFiles || {} },
   #        { messages: formattedMessages || [] }
   #    );

   # 4. Pass State to Network Run:
   #    const result = await network.run(event.data.value, { state });

   # 5. Dynamic System Prompt with File Context:
   #    const buildContextPrompt = () => {
   #        const existingFileNames = Object.keys(latestFiles || {});
   #        if (existingFileNames.length === 0) return PROMPT;
   #
   #        const filesContext = `
   #        CONVERSATION CONTEXT:
   #        You are continuing a previous conversation.
   #        Files already created: ${existingFileNames.join(", ")}
   #        ...
   #        `;
   #        return filesContext + PROMPT;
   #    };

   ### Key Points:
   # - Messages sorted ASC (chronological) not DESC
   # - Include fragments relation to get file data
   # - Exclude ERROR type messages from context
   # - Limit to 30 messages to prevent token overflow
   # - Pre-load files into state.data.files for agent access
   # - Inject file list into system prompt for context awareness

## 16. Clerk Plans & Usage Tracking

   ### Clerk Dashboard Setup
   # 1. Go to Clerk Dashboard > Users > Metadata
   # 2. Add custom public metadata for plans:
   #    - plan: "free" | "pro" | "enterprise"
   #    - usage: { tokens: number, limit: number }

   ### Rate Limiting Implementation
   # Using rate-limiter-flexible for API protection
   # See: src/lib/rate-limiter.js
   # Protected routes: /api/messages, Inngest triggers

## 17. Recent Updates & File Changes

   ### src/app/projects/[projectId]/page.jsx
   # Changed: Uses ProjectViewWrapper instead of direct ProjectView import
   # Reason: Fixes hydration mismatch from SSR

   ### src/app/projects/[projectId]/project-view-wrapper.jsx (NEW)
   # Purpose: Client-side wrapper with dynamic import (ssr: false)
   # Fixes: Hydration mismatch from ResizablePanels and Radix UI

   ### src/inngest/functions.js
   # Enhanced: Added conversation history loading with createState
   # Features:
   #   - Loads previous messages in chronological order
   #   - Extracts files from fragments into initial state
   #   - Dynamic system prompt with file context
   #   - Excludes error messages from history
   #   - Limits to 30 messages for token efficiency

## Quick Reference: Install All Packages

   ### One-liner to install all dependencies:
   npm install @clerk/nextjs @clerk/themes @prisma/client @tanstack/react-query @inngest/agent-kit @e2b/code-interpreter inngest zod sonner next-themes react-resizable-panels@3.0.6 react-hook-form @hookform/resolvers react-textarea-autosize prismjs streamdown date-fns embla-carousel-react recharts vaul cmdk react-day-picker input-otp random-word-slugs rate-limiter-flexible

   ### Dev dependencies:
   npm install -D tailwindcss@4 @tailwindcss/postcss eslint eslint-config-next tw-animate-css

   ### Initialize Shadcn (installs Radix UI + utilities):
   npx shadcn@latest init

   ### Prisma:
   npm install prisma@5.22.0 @prisma/client@5.22.0
   npx prisma init
   npx prisma generate


